name: Packages

# Before pushing to trigger this script, remember to edit the list of packages
# in `build-external-packages`, if you don't want to rebuild all of them.

on:
  push:
    branches:
      - 'packages-upload-new/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build
    strategy:
      matrix:
        os: ['ubuntu-22.04', 'macos-11', 'macos-12', 'windows-2022']
    runs-on: ${{ matrix.os }}
    env:
      CONAN_REVISIONS_ENABLED: 1
    steps:

    - uses: actions/checkout@v3

    - name: Install conan
      uses: turtlebrowser/get-conan@v1.1

    - name: Set up conan
      shell: bash
      run: ./.github/workflows/conan-setup

    - name: authenticate to repository
      run: conan user -p ${{ secrets.JFROG_ARTIFACTORY_TOKEN_2 }} -r tket-libs ${{ secrets.JFROG_ARTIFACTORY_USER_2 }}

    - name: Install and upload packages
      shell: bash
      run: ./.github/workflows/build-external-packages

  build_macos_arm64:
    name: Build on MacOS ARM64
    runs-on: ['self-hosted', 'macOS', 'ARM64']
    env:
      CONAN_REVISIONS_ENABLED: 1
    steps:

    - uses: actions/checkout@v3

    - name: Set up conan
      shell: bash
      run: ./.github/workflows/conan-setup

    - name: authenticate to repository
      run: conan user -p ${{ secrets.JFROG_ARTIFACTORY_TOKEN_2 }} -r tket-libs ${{ secrets.JFROG_ARTIFACTORY_USER_2 }}

    - name: Install and upload packages
      shell: bash
      run: ./.github/workflows/build-external-packages

    - name: unauthenticate
      run: conan user -c
